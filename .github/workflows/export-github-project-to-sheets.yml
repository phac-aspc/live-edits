name: Export GitHub Project to Google Sheets

on:
  schedule:
    # Run every Thursday at 11 AM UTC (adjust timezone as needed)
    - cron: '0 11 * * 4'
  workflow_dispatch:
    inputs:
      create_new_tab:
        description: 'Create a new tab for this export'
        required: false
        default: true
        type: boolean

jobs:
  export-project-data:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: read
      pull-requests: read
      repository-projects: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: Export GitHub Project to Google Sheets
        env:
          PRODUCTS_TOKEN: ${{ secrets.PRODUCTS_TOKEN }}
          GITHUB_ORG: phac-aspc
          GITHUB_PROJECT_NUMBER: 1
          GITHUB_VIEW_NUMBER: 8
          GOOGLE_SHEETS_ID: 1c9O1ssuicTxK7JVoQYwqtsyTCpYH1tOLl0EKw2AV4S0
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          CREATE_NEW_TAB: ${{ github.event.inputs.create_new_tab || 'true' }}
        run: |
          python .github/scripts/export-to-sheets.py
